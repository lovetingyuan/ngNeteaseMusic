!function(e){"use strict";e&&e.module("neteaseMusic",[]).factory("styleService",["$templateCache","$q",function(e){function t(t,n){var i=e.get(t);i&&e.put(t,i.replace(/class="([\s\S]*?)"/g,function(e,t){t=t.split(" ");var i=[];return angular.forEach(t,function(e){i.push(0===e.indexOf("@")?'class="'+e.substr(1)+'"':'class="'+n+"-"+e+'"')}),i.join(" ")}))}function n(e,t){function i(e,t){var n=[];return t=t?t+"-":"",angular.forEach(e.split("$"),function(e){n.push(t+e.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()}))}),t?n:n[0]}var o,r;for(r in e)e.hasOwnProperty(r)&&(o=e[r],delete e[r],angular.isObject(o)?(angular.forEach(i(r,t),function(t){e[t]=angular.merge(o,e[t]||{})}),n(o,t)):e[i(r)]=o)}function i(e,t){function n(e,t){var o=t+"{";for(var r in e)e.hasOwnProperty(r)&&(angular.isObject(e[r])?i.push(n(e[r],t+" ."+r)):o+=r+":"+e[r]+";");return o+="}"}var i=[];return i.unshift(n(e,"."+t)),i.join("")}function o(e,t){var n=document.getElementById(t);n?n.innerHTML+=e:(n=angular.element('<style type="text/css" id="'+t+'">'+e+"</style>")[0],document.getElementsByTagName("head")[0].appendChild(n))}return{setStyle:function(e,r,a){t(a,r),n(e,r),o(i(e,r),r)}}}]).run(["$templateCache","$sce","styleService",function(e,t,n){var i="netease-"+ +new Date+(Math.random()+"").substr(2);e.put("player.html",'         <div class="@'+i+'">             <div>                <iframe ng-src={{other.firstItem}} ng-show="!!other.firstItem" class="main-iframe" ></iframe>                 <div style="padding: 0 10px;" ng-show="other.showBar">                     <ul class="option-bar">                        <li class="option-bar-title">                            <a ng-href="{{other.currentSong}}" target="_blank"                             ng-show="!other.addMode" style="text-decoration:none;">网易云音乐</a>                             <span style="color: red;" ng-show="other.isError">(刚刚的输入有误)</span>                             <span ng-show="other.isLoading">正在加载...</span>                             <input name="addSongInput" type="url" autofocus placeholder="请输入网易云音乐链接" ng-model="other.theAddSongLink" ng-show="other.addMode" class="option-bar-input"/>                         </li>                         <li ng-click="addSong()" title="添加歌曲" class="option-bar-btn">{{other.addMode ? \'&#10004;\' : \'&#10010;\'}}</li>                        <li ng-click="other.showList = !other.showList" class="option-bar-btn" title="{{other.showList ? \'收起列表\' : \'展开列表\'}}">&#8801;</li>                    </ul>                </div>             </div>             <div ng-show="other.showList" class="play-list"></div>         </div>');var o={mainIframe:{margin:0,padding:0,border:"0 none",width:"100%",marginBottom:"-12px"},optionBar:{listStyle:"none",margin:0,padding:0,fontSize:"18px",height:"25px",lineHeight:"25px",color:"#898989",backgroundColor:"white",boxShadow:"0 0 10px #ccc",borderRadius:"2px",optionBarTitle:{"float":"left",marginLeft:"10px",fontSize:"13px",optionBarInput:{height:"25px",border:"0 none",outline:"none",width:"95%"}},optionBarBtn:{"float":"right",marginRight:"10px",cursor:"pointer"}},playList:{position:"relative",top:"-8px"}};e.put("song.item.html",'        <div class="item" ng-show="iframeReady">            <iframe ng-src="{{safeSongLink}}" class="item-frame"></iframe>             <div ng-click="deleteTheSong()" title="删除该歌曲"                   class="item-delete-btn">&#215;</div>             <div ng-click="setTheSong()" title="播放该歌曲"                class="item-play-btn">&#9835;</div>             <!-- <div style="position: absolute; background:white;height: 8px; left: 45px; right: 45px; top: 32px;"></div> -->          </div>     ');var r={item:{position:"relative"},itemFrame:{margin:0,padding:0,border:"0 none",height:"52px",width:"100%",marginBottom:"-23px"},itemDeleteBtn$itemPlayBtn:{position:"absolute",top:"10px",width:"32px",height:"32px",lineHeight:"32px",textAlign:"center",cursor:"pointer"},itemDeleteBtn:{right:"10px",backgroundColor:"white",color:"#898989",borderRadius:"0 2px 2px 0",fontSize:"25px"},itemPlayBtn:{left:"10px",backgroundColor:"#f3f3f3",color:"#ED1C24",borderRadius:"2px 0 0 2px",fontSize:"20px"}};n.setStyle(o,i,"player.html"),n.setStyle(r,i,"song.item.html")}]).run(function(){var e=angular.element;e.prototype.index=function(){for(var e=this.parent().children(),t=0,n=e.length;n>t;t++)if(e[t]===this[0])return t},e.prototype.swap=function(e){var t=this.parent();"number"==typeof e&&(e=t.children().eq(e));var n=e[0].nextSibling;t[0].insertBefore(e[0],this[0]),n?t[0].insertBefore(this[0],n):t.append(this)}}).directive("musicItem",["$templateCache","$sce",function(e,t){return{restrict:"AE",replace:!0,scope:{songLink:"@",deleteSong:"&",setSong:"&"},template:e.get("song.item.html"),link:function(e,n,i){e.safeSongLink=t.trustAsResourceUrl(i.songLink);var o=n.find("iframe")[0];e.$emit("iframeLoading"),o.onload=function(){o.src&&(e.iframeReady=!0,e.$digest(),e.$emit("iframeLoaded"))},e.setTheSong=function(){e.iframeReady=!1,e.$emit("iframeLoading"),e.setSong({index:n.index()})},e.deleteTheSong=function(){e.$broadcast("$destroy"),e.deleteSong({index:n.index()})}}}}]).directive("musicPlayer",["$templateCache","$sce","$timeout","$compile","styleService",function(t,n,i,o){return{restrict:"AE",replace:!0,require:"?ngModel",scope:{playConfig:"="},template:t.get("player.html"),link:function(t,r,a,s){function l(e){var t=+e;return"number"==typeof t&&t===t?t:e.match(/(?:id\=)(\d+)/g)?+RegExp.$1:null}function d(e){return"http://music.163.com/outchain/player?type=2&id="+e+"&auto=0&height=32"}if(!s)throw Error("directive musicPlayer need ng-model!");var u=r.children("div").eq(1);t.$on("iframeLoading",function(){t.other.isLoading=!0}),t.$on("iframeLoaded",function(){for(var e=u.children(),n=!0,i=0,o=e.length;o>i;i++)if(!e.eq(i).isolateScope().iframeReady){n=!1;break}t.other.isLoading=!n,t.$digest()});var c={autoPlay:!0,size:"normal",fold:!1};e.extend(c,t.playConfig||{}),t.other={showList:!c.fold,addMode:!1,showBar:!0,theAddSongLink:"",currentSong:"",firstItem:"",isError:!1,isLoading:!0};var h=!0,p=!1,g=function(e){var i=n.trustAsHtml('<music-item song-link="'+e+'" delete-song="deleteSong(index)" set-song="setCurrentSong(index)" /> ');u.append(o(n.getTrustedHtml(i))(t))};s.$render=function(i){var o,a,l,d;if(h)s.$modelValue.length&&r.find("iframe").attr("height",("small"===c.size?32:66)+20),e.forEach(s.$viewValue,function(e){g(e)}),a=c.autoPlay?1:0,o="small"===c.size?32:66,t.other.firstItem=s.$modelValue[0]?n.trustAsResourceUrl("http://music.163.com/outchain/player?type=2&id="+s.$modelValue[0]+"&auto="+a+"&height="+o):"";else{var f=u.children("div");l=f.length,d=s.$modelValue.length,l===d?(console.log(i),u.prepend(f.eq(i)),p=!0):d>l?(g(s.$viewValue[d-1]),p=1===d):(f.eq(i).remove(),p=0===i),p&&(t.other.currentSong=s.$modelValue[0]?"http://music.163.com/#/song?id="+s.$modelValue[0]:"http://music.163.com/",o="small"===c.size?32:66,t.other.firstItem=s.$modelValue[0]?n.trustAsResourceUrl("http://music.163.com/outchain/player?type=2&id="+s.$modelValue[0]+"&auto=1&height="+o):"")}h=!1},s.$formatters.push(function(t){var n=[];return e.forEach(t,function(e){n.push(d(e))}),n}),s.$parsers.push(function(t){var n=[];return e.forEach(t,function(e){n.push(l(e))}),n}),r.find("input").on("keydown",function(e){13===e.keyCode&&t.addSong().$digest()}),t.addSong=function(){if(t.other.addMode){if(t.other.theAddSongLink){var e=d(l(t.other.theAddSongLink));t.other.theAddSongLink="",s.$viewValue.push(e),s.$setViewValue(s.$viewValue.slice()),s.$render(null)}else t.other.isError=!0,i(function(){t.other.isError=!1},2e3);t.other.addMode=!1}else t.other.isError=!1,t.other.addMode=!0,r.find("input").val(""),setTimeout(function(){r.find("input")[0].focus()});return t},t.deleteSong=function(e){s.$viewValue.splice(e,1),s.$setViewValue(s.$viewValue.slice()),s.$render(e)},t.setCurrentSong=function(e){var t=s.$viewValue[e];s.$viewValue.splice(e,1),s.$viewValue.unshift(t),s.$setViewValue(s.$viewValue.slice()),s.$render(e)}}}}])}(angular);